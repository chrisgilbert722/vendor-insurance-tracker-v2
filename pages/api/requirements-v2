// pages/api/requirements-v2/index.js
import { Client } from "pg";

export const config = {
  api: { bodyParser: true },
};

export default async function handler(req, res) {
  const { orgId } = req.query;

  if (!orgId) {
    return res
      .status(400)
      .json({ ok: false, error: "Missing orgId in query." });
  }

  const client = new Client({
    connectionString: process.env.DATABASE_URL,
  });

  try {
    await client.connect();

    if (req.method === "GET") {
      // List requirements for this org
      const result = await client.query(
        `
        SELECT
          id,
          org_id,
          coverage_type,
          rule_group,
          min_limit_each_occurrence,
          min_limit_aggregate,
          require_additional_insured,
          require_waiver_of_subrogation,
          min_risk_score,
          required,
          created_at
        FROM public.requirements
        WHERE org_id = $1
        ORDER BY rule_group NULLS FIRST, coverage_type ASC
        `,
        [orgId]
      );

      return res.status(200).json({
        ok: true,
        requirements: result.rows,
      });
    }

    if (req.method === "POST") {
      const {
        coverage_type,
        rule_group,
        min_limit_each_occurrence,
        min_limit_aggregate,
        require_additional_insured,
        require_waiver_of_subrogation,
        min_risk_score,
        required,
      } = req.body;

      if (!coverage_type) {
        return res.status(400).json({
          ok: false,
          error: "coverage_type is required",
        });
      }

      const insert = await client.query(
        `
        INSERT INTO public.requirements
          (org_id, coverage_type, rule_group,
           min_limit_each_occurrence, min_limit_aggregate,
           require_additional_insured, require_waiver_of_subrogation,
           min_risk_score, required)
        VALUES
          ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        RETURNING
          id,
          org_id,
          coverage_type,
          rule_group,
          min_limit_each_occurrence,
          min_limit_aggregate,
          require_additional_insured,
          require_waiver_of_subrogation,
          min_risk_score,
          required,
          created_at
        `,
        [
          orgId,
          coverage_type,
          rule_group || null,
          min_limit_each_occurrence ? Number(min_limit_each_occurrence) : null,
          min_limit_aggregate ? Number(min_limit_aggregate) : null,
          Boolean(require_additional_insured),
          Boolean(require_waiver_of_subrogation),
          min_risk_score ? parseInt(min_risk_score, 10) : null,
          required !== undefined ? Boolean(required) : true,
        ]
      );

      return res.status(201).json({
        ok: true,
        requirement: insert.rows[0],
      });
    }

    return res
      .status(405)
      .json({ ok: false, error: "Method not allowed" });
  } catch (err) {
    console.error("Requirements V2 index error:", err);
    return res.status(500).json({
      ok: false,
      error: err.message || "Requirements V2 API error",
    });
  } finally {
    try {
      await client.end();
    } catch (_) {}
  }
}
